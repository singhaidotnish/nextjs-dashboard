{"version":3,"sources":["../../src/diagnostics/build-diagnostics.ts"],"sourcesContent":["import { mkdir, readFile, writeFile } from 'fs/promises'\nimport { join } from 'path'\nimport { traceGlobals } from '../trace/shared'\n\nconst DIAGNOSTICS_DIR = 'diagnostics'\nconst DIAGNOSTICS_FILE = 'build-diagnostics.json'\n\ninterface BuildDiagnostics {\n  // The current stage of the build process. This should be updated as the\n  // build progresses so it's what stage the build was in when an error\n  // happened.\n  buildStage?: string\n  // Additional debug information about the configuration for the build.\n  buildOptions?: Record<string, string>\n}\n\nasync function getDiagnosticsDir(): Promise<string> {\n  const distDir = traceGlobals.get('distDir')\n  const diagnosticsDir = join(distDir, DIAGNOSTICS_DIR)\n  await mkdir(diagnosticsDir, { recursive: true })\n  return diagnosticsDir\n}\n\n/**\n * Saves the exact version of Next.js that was used to build the app to a diagnostics file.\n */\nexport async function recordFrameworkVersion(version: string): Promise<void> {\n  const diagnosticsDir = await getDiagnosticsDir()\n  const frameworkVersionFile = join(diagnosticsDir, 'framework.json')\n  await writeFile(frameworkVersionFile, JSON.stringify({ version }))\n}\n\n/**\n * Saves build diagnostics information to a file. This method can be called\n * multiple times during a build to save additional information that can help\n * debug a build such as what stage the build was in when a failure happened.\n * Each time this method is called, the new information will be merged with any\n * existing build diagnostics that previously existed.\n */\nexport async function updateBuildDiagnostics(\n  diagnostics: BuildDiagnostics\n): Promise<void> {\n  const diagnosticsDir = await getDiagnosticsDir()\n  const diagnosticsFile = join(diagnosticsDir, DIAGNOSTICS_FILE)\n\n  const existingDiagnostics: BuildDiagnostics = JSON.parse(\n    await readFile(diagnosticsFile, 'utf8').catch(() => '{}')\n  ) as BuildDiagnostics\n  const updatedBuildOptions = {\n    ...(existingDiagnostics.buildOptions ?? {}),\n    ...(diagnostics.buildOptions ?? {}),\n  }\n  const updatedDiagnostics = {\n    ...existingDiagnostics,\n    ...diagnostics,\n    buildOptions: updatedBuildOptions,\n  }\n  await writeFile(diagnosticsFile, JSON.stringify(updatedDiagnostics, null, 2))\n}\n"],"names":["recordFrameworkVersion","updateBuildDiagnostics","DIAGNOSTICS_DIR","DIAGNOSTICS_FILE","getDiagnosticsDir","distDir","traceGlobals","get","diagnosticsDir","join","mkdir","recursive","version","frameworkVersionFile","writeFile","JSON","stringify","diagnostics","diagnosticsFile","existingDiagnostics","parse","readFile","catch","updatedBuildOptions","buildOptions","updatedDiagnostics"],"mappings":";;;;;;;;;;;;;;;IA0BsBA,sBAAsB;eAAtBA;;IAaAC,sBAAsB;eAAtBA;;;0BAvCqB;sBACtB;wBACQ;AAE7B,MAAMC,kBAAkB;AACxB,MAAMC,mBAAmB;AAWzB,eAAeC;IACb,MAAMC,UAAUC,oBAAY,CAACC,GAAG,CAAC;IACjC,MAAMC,iBAAiBC,IAAAA,UAAI,EAACJ,SAASH;IACrC,MAAMQ,IAAAA,eAAK,EAACF,gBAAgB;QAAEG,WAAW;IAAK;IAC9C,OAAOH;AACT;AAKO,eAAeR,uBAAuBY,OAAe;IAC1D,MAAMJ,iBAAiB,MAAMJ;IAC7B,MAAMS,uBAAuBJ,IAAAA,UAAI,EAACD,gBAAgB;IAClD,MAAMM,IAAAA,mBAAS,EAACD,sBAAsBE,KAAKC,SAAS,CAAC;QAAEJ;IAAQ;AACjE;AASO,eAAeX,uBACpBgB,WAA6B;IAE7B,MAAMT,iBAAiB,MAAMJ;IAC7B,MAAMc,kBAAkBT,IAAAA,UAAI,EAACD,gBAAgBL;IAE7C,MAAMgB,sBAAwCJ,KAAKK,KAAK,CACtD,MAAMC,IAAAA,kBAAQ,EAACH,iBAAiB,QAAQI,KAAK,CAAC,IAAM;IAEtD,MAAMC,sBAAsB;QAC1B,GAAIJ,oBAAoBK,YAAY,IAAI,CAAC,CAAC;QAC1C,GAAIP,YAAYO,YAAY,IAAI,CAAC,CAAC;IACpC;IACA,MAAMC,qBAAqB;QACzB,GAAGN,mBAAmB;QACtB,GAAGF,WAAW;QACdO,cAAcD;IAChB;IACA,MAAMT,IAAAA,mBAAS,EAACI,iBAAiBH,KAAKC,SAAS,CAACS,oBAAoB,MAAM;AAC5E"}